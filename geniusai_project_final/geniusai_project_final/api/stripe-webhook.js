import Stripe from 'stripe'; import { supabase } from './_helpers/supabaseClient.js'; const stripe = new Stripe(process.env.STRIPE_SECRET_KEY); const endpointSecret = process.env.STRIPE_WEBHOOK_SECRET; export default async function handler(req,res){ if(req.method!=='POST') return res.status(405).end(); const sig = req.headers['stripe-signature']; let event; try{ const buf = await getRawBody(req); event = stripe.webhooks.constructEvent(buf, sig, endpointSecret); }catch(e){ return res.status(400).send('invalid signature'); } if(event.type==='checkout.session.completed'){ const session = event.data.object; const email = session.metadata?.email || session.customer_details?.email; await supabase.from('registrations').upsert({email,paid:true},{onConflict:'email'}); } res.json({received:true}); } async function getRawBody(req){ const chunks=[]; for await(const c of req) chunks.push(c); return Buffer.concat(chunks);}