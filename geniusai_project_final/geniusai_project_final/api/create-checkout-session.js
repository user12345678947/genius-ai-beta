import Stripe from 'stripe'; import { supabase } from './_helpers/supabaseClient.js'; const stripe = new Stripe(process.env.STRIPE_SECRET_KEY); export default async function handler(req,res){ if(req.method!=='POST') return res.status(405).end(); const {email,referral} = req.body; if(!email) return res.status(400).json({error:'email required'}); const customers = await stripe.customers.list({email,limit:1}); let customer = customers.data[0]; if(!customer) customer = await stripe.customers.create({email}); const session = await stripe.checkout.sessions.create({ mode:'subscription', customer: customer.id, line_items:[{price: process.env.PRICE_ID_MONTHLY, quantity:1}], metadata:{email,referral:referral||''}, success_url: process.env.SUCCESS_URL.replace('{CHECKOUT_SESSION_ID}','{CHECKOUT_SESSION_ID}'), cancel_url: process.env.CANCEL_URL }); return res.json({url: session.url}); }